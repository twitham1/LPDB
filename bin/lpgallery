#!/usr/bin/perl

=pod

=head1 NAME

lpgallery - remote-control (keyboard) driven local picture browser

=head1 FEATURES

UNDER CONSTRUCTION - for getting Prima LPDB browser up and running,
similar to picasagallery or mythgallery, like for mythtv

=cut

# by twitham@sbcglobal.net in 2020 based on picasagallery of 2013

# TODO: navigation object needed, sortable by basename or average
# time, via a database view over all files and virtual dirs:

# basename, displayed for dirs
# count, displayed for dirs (changes by filtering)
# average time of all photos (could change by filtering?)
# caption, optionally displayed for files (Picasa description for dirs)
# parent node, / for root [dirs]

# now all navigation/sorting is available from DB queries: start with
# all nodes that have / parent, drill down from there.  GUI can
# concatenate the full path to node and know all siblings.

use strict;
use warnings;
use Prima qw(Application);
use Prima::Image::Magick qw/:all/;
use LPDB;
use Prima::LPDB::ThumbViewer;

my $file = '.lpdb.db';
my $create = -f $file ? 0 : 1;
my $lpdb = new LPDB({dbfile => $file,
#		     sqltrace => 1,
		    });
$lpdb->create if $create;
my $child;
if ($child = fork) {
    sleep 2;
} else {
    $lpdb->update('./');
    exit;
}

my $l;				# ListViewer
my $w = Prima::MainWindow->create(
    # background => 'black',	# how to default these?
    # foreground => 'white',
    text => 'Local Picture Gallery',
    packPropagate => 0,
    menuItems => [
    	['~Options' => [
    	     ['bigger', 'Zoom ~In', '=', ord '=' => sub { $l->bigger } ],
    	     ['smaller', 'Zoom ~Out', '-', ord '-' => sub { $l->smaller } ],
    	     ['crops', '~Crop', 'c', ord 'c' => sub {
    		 $l->{crops} = $_[0]->menu->toggle($_[1]);
    		 $l->repaint;
    	      } ],
    	     ['quit', '~Quit', 'Ctrl+Q', '^q' => sub { $::application->close } ],
    	 ]
    	]],
    );
$w->font->name('bitstream charter'); # hack!!!! how to find best font?
$w->font->height(28);
#$w->font->style(fs::Italic);

#print sort map {"$_->{name}\n"} @{$::application-> fonts}; # see available fonts!!!

$l = $w->insert(
    'Prima::LPDB::ThumbViewer',
    lpdb => $lpdb,		# LPDB connection required in advance
    onKeyDown => sub {
#	warn "@_\n";
    	# if ($_[2] == ord 'm') {
    	#     $w->popup;
    	# }
    },
    onClick => sub {
	print $_[0]-> focusedItem, " is clicked\n";
    },
    pack => { expand => 1, fill => 'both' },
    );

warn " brief keys ", $l->briefKeys;

# $l->focusedItem(0);
# $l->reset;
$l->smaller;			# resize thumbs to fill the window

run Prima;

exit 0;

=pod

=back

=head1 TODO

Add documenation from picasagallery here!!!

=head1 SEE ALSO
L<LPDB>, L<picasagallery>, L<Prima>

=head1 AUTHOR

Timothy D Witham <twitham@sbcglobal.net>

=head1 COPYRIGHT AND LICENSE

Copyright 2013-2022 Timothy D Witham.

This program is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=cut
